---
title: "Analises_"
date: "2024-01-22"
output:
  word_document: default
  html_document: default
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE, 
  message = FALSE, 
  error = FALSE, 
  warning = FALSE,
  comment = "#>"
)
```

### Carregando bibliotecas
```{r}
library(tidyverse)
library(geobr)
source("R/gafico.R")
```

### Carregando as bases de dados

```{r}
emissions_sources <- read_rds("data/emissions_sources.rds") %>% 
  mutate(source_name_1 = str_to_title(source_name))
states <- read_rds("data/states.rds") %>% 
  mutate(name_region = ifelse(name_region == "Centro Oeste","Centro-Oeste",name_region))

brazil_ids <- read_rds("data/df_nome.rds")
glimpse(emissions_sources)
nomes_uf <- c(brazil_ids$nome_uf %>% unique(),"Brazil")
abbrev_states <- brazil_ids$sigla_uf %>% unique()
region_names <- brazil_ids$nome_regiao %>% unique()
```


### Mapeando  Fontes e Sumidouros

```{r}

anos <- 2019:2022

for(i in seq_along(anos)){
  plot_source_sink <- states |> 
  ggplot() +
  geom_sf(fill="white", color="black",
          size=.15, show.legend = FALSE) +
  geom_point(
    data = emissions_sources |> 
    filter(year == anos[i],
           gas == "co2e_100yr",
           !source_name %in% nomes_uf,
           !sub_sector %in% c("forest-land-clearing",
                              "forest-land-degradation",
                              "shrubgrass-fires",
                              "forest-land-fires",
                              "wetland-fires",
                              "removals")
    ) %>% 
    group_by(lon,lat,city_ref) %>% 
    summarise(
      emission = sum(emissions_quantity, na.rm=TRUE)
    ) %>% 
    mutate(
      fonte_sumidouro = ifelse(emission <=0, "Sink","Source")
      ),
    aes(lon,lat,color=fonte_sumidouro)) +
    scale_color_manual(values = c("green","darkred"))+
    tema_mapa()+
    labs(x='Longitude',y='Latitude',col=expression('CO'[2]))
    
  
  ggplot2::ggsave(paste0('img/source_sink_',anos[i],'.png'),
                  units="in", width=8, height=6,
                  dpi=1000)
  print(plot_source_sink)
}
 

```


```{r}
emissions_sources |>
  filter(year > 2018 & year < 2023,
           gas == "co2e_100yr",
           !source_name %in% nomes_uf,
           !sub_sector %in% c("forest-land-clearing",
                              "forest-land-degradation",
                              "shrubgrass-fires",
                              "forest-land-fires",
                              "wetland-fires",
                              "removals")
    ) |> 
  mutate(
    region = case_when(
      nome_regiao=='Norte'~'North',
      nome_regiao=='Nordeste'~'Northeast',
      nome_regiao=='Sul'~'South',
      nome_regiao=='Sudeste'~'Southeast',
      nome_regiao=='Centro-Oeste'~'Midweast',
      .default = 'Other'
      )
    ) |> 
    group_by(region,year) |> 
    summarise(
      ghg_balance = sum(emissions_quantity, na.rm=TRUE)
    ) |> 
  ggplot(aes(x=year,y=ghg_balance/1e7,fill=region))+
  geom_col(position = 'dodge')+
  scale_fill_viridis_d()+
  labs(x='Year',y=expression('CO'[2]~'eq Balance ('~year^-1~')'),fill='Region')

```


```{r}
emissions_sources |>
  filter(year > 2018 & year < 2023,
           gas == "co2e_100yr",
           !source_name %in% nomes_uf,
           !sub_sector %in% c("forest-land-clearing",
                              "forest-land-degradation",
                              "shrubgrass-fires",
                              "forest-land-fires",
                              "wetland-fires",
                              "removals")
    ) |> 
  mutate(
    region = case_when(
      nome_regiao=='Norte'~'North',
      nome_regiao=='Nordeste'~'Northeast',
      nome_regiao=='Sul'~'South',
      nome_regiao=='Sudeste'~'Southeast',
      nome_regiao=='Centro-Oeste'~'Midweast',
      .default = 'Other'
      )
    ) |> 
    group_by(region,sub_sector,year) |> 
    summarise(
      ghg_balance = sum(emissions_quantity, na.rm=TRUE)
    ) |> 
  ggplot(aes(x=year,y=ghg_balance/1e7,fill=sub_sector))+
  geom_col(position = 'dodge')+
  scale_fill_viridis_d()+
  facet_wrap(~region,scales='free')+
  labs(x='Year',y=expression('CO'[2]~'eq Balance ('~year^-1~')'),fill='Sector')

```
